<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>GazelBooks ‚Äî Pembukuan UMKM (MVP)</title>
  <meta name="description" content="GazelBooks MVP: pembukuan sederhana UMKM. Buku kas, invoice, hutang/piutang, laporan, export, dan kalkulator keuangan." />
  <style>
    :root{
      --bg:#070b14;
      --panel:#0b1220;
      --text:#e7eefc;
      --muted:#9bb0d1;
      --muted2:#7f95bd;
      --line:rgba(255,255,255,.08);
      --soft:rgba(255,255,255,.04);
      --brand:#7c3aed;
      --brand2:#a78bfa;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:20px;
      --radius2:26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(900px 520px at 20% 0%, rgba(124,58,237,.22), transparent 60%),
        radial-gradient(800px 520px at 100% 30%, rgba(34,197,94,.10), transparent 60%),
        radial-gradient(800px 520px at 50% 120%, rgba(59,130,246,.12), transparent 60%),
        linear-gradient(180deg, #060914 0%, #070b14 100%);
      color:var(--text);
      overflow-x:hidden;
    }
    a{ color:inherit; text-decoration:none; }
    button, input, select, textarea{ font:inherit; }
    ::-webkit-scrollbar{ width:10px; height:10px; }
    ::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.12); border-radius:999px; }
    ::-webkit-scrollbar-track{ background:rgba(255,255,255,.03); }

    .app{ min-height:100vh; display:grid; grid-template-columns: 290px 1fr; }
    .sidebar{
      position:sticky; top:0; height:100vh; padding:18px;
      border-right:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      backdrop-filter: blur(10px);
    }
    .main{ padding:18px; min-width:0; }
    .brand{
      display:flex; align-items:center; gap:12px;
      padding:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.28), transparent 45%),
        linear-gradient(135deg, rgba(124,58,237,1), rgba(59,130,246,1));
      display:grid; place-items:center;
      font-weight:900; letter-spacing:.5px;
    }
    .brand h1{ margin:0; font-size:15px; line-height:1.2; }
    .brand p{ margin:2px 0 0; color:var(--muted); font-size:12px; }

    .nav{ margin-top:14px; display:flex; flex-direction:column; gap:8px; }
    .nav button{
      text-align:left; border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      color:var(--text);
      padding:12px; border-radius:16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .nav button:hover{ transform: translateY(-1px); border-color: rgba(167,139,250,.35); background: rgba(124,58,237,.08); }
    .nav button.active{ border-color: rgba(167,139,250,.55); background: rgba(124,58,237,.12); }
    .nav .left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .ico{
      width:34px; height:34px; border-radius:12px;
      display:grid; place-items:center;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      flex:0 0 auto;
    }
    .nav .title{ font-weight:700; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .nav .sub{ display:block; color:var(--muted); font-size:11px; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .chip{
      font-family:var(--mono);
      font-size:11px;
      color:rgba(255,255,255,.9);
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:6px 8px;
      border-radius:999px;
    }
    .sideFooter{
      position:absolute; left:18px; right:18px; bottom:18px;
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      background: rgba(255,255,255,.02);
    }
    .sideFooter .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .sideFooter .small{ color:var(--muted); font-size:12px; margin-top:6px; line-height:1.4; }

    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
      padding:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
    }
    .topbar h2{ margin:0; font-size:18px; letter-spacing:-.2px; }
    .topbar p{ margin:6px 0 0; color:var(--muted); font-size:13px; }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      display:inline-flex; align-items:center; gap:10px;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(167,139,250,.35); background: rgba(124,58,237,.10); }
    .btn.primary{ border-color: rgba(167,139,250,.55); background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(59,130,246,.85)); }
    .btn.primary:hover{ background: linear-gradient(135deg, rgba(124,58,237,1), rgba(59,130,246,.95)); }
    .btn.danger:hover{ border-color: rgba(239,68,68,.5); background: rgba(239,68,68,.10); }

    .content{ margin-top:14px; display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; align-items:start; }
    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .card .hd h3{ margin:0; font-size:14px; }
    .card .hd .muted{ color:var(--muted); font-size:12px; }
    .card .bd{ padding:14px; }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }

    .kpi{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      padding:12px;
    }
    .kpi .label{ color:var(--muted); font-size:12px; }
    .kpi .val{ margin-top:8px; font-size:18px; font-weight:800; letter-spacing:-.3px; }
    .kpi .hint{ margin-top:4px; color:var(--muted2); font-size:12px; }
    .kpi.good .val{ color: rgba(34,197,94,.95); }
    .kpi.bad .val{ color: rgba(239,68,68,.95); }

    .form{ display:grid; gap:10px; }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    .field input, .field select, .field textarea{
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      color:var(--text);
      padding:11px 12px;
      border-radius: 14px;
      outline:none;
      transition: border-color .12s ease, background .12s ease;
    }
    .field textarea{ min-height:88px; resize: vertical; }
    .field input:focus, .field select:focus, .field textarea:focus{
      border-color: rgba(167,139,250,.55);
      background: rgba(124,58,237,.06);
    }
    .hintLine{ color:var(--muted2); font-size:12px; line-height:1.35; }

    .tableWrap{ overflow:auto; border-radius:18px; border:1px solid var(--line); }
    table{ width:100%; border-collapse:collapse; min-width: 860px; }
    th, td{ padding:12px; border-bottom:1px solid var(--line); text-align:left; vertical-align:top; }
    th{ font-size:12px; color:var(--muted); font-weight:700; background: rgba(255,255,255,.02); position:sticky; top:0; z-index:1; }
    td{ font-size:13px; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color: rgba(255,255,255,.92);
      white-space:nowrap;
    }
    .badge.in{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.08); }
    .badge.out{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.08); }
    .mono{ font-family:var(--mono); }
    .tdActions{ display:flex; gap:8px; justify-content:flex-end; }
    .iconBtn{
      width:38px; height:38px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      color:var(--text);
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      display:grid; place-items:center;
    }
    .iconBtn:hover{ transform: translateY(-1px); border-color: rgba(167,139,250,.35); background: rgba(124,58,237,.08); }
    .iconBtn.danger:hover{ border-color: rgba(239,68,68,.5); background: rgba(239,68,68,.10); }

    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modalOverlay.open{ display:flex; }
    .modal{
      width:min(920px, 100%);
      border:1px solid var(--line);
      background: rgba(11,18,32,.92);
      border-radius: 26px;
      box-shadow: 0 25px 90px rgba(0,0,0,.6);
      overflow:hidden;
    }
    .modal .mh{
      padding:14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .modal .mh h3{ margin:0; font-size:15px; }
    .modal .mh p{ margin:6px 0 0; color:var(--muted); font-size:12px; }
    .modal .mb{ padding:14px; }

    .toast{
      position:fixed; right:18px; bottom:18px;
      width:min(420px, calc(100% - 36px));
      border:1px solid var(--line);
      background: rgba(11,18,32,.88);
      border-radius: 20px;
      padding:12px;
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
      display:none;
      z-index:60;
    }
    .toast.open{ display:block; }
    .toast .t1{ font-weight:800; }
    .toast .t2{ margin-top:4px; color:var(--muted); font-size:13px; line-height:1.35; }

    .mNav{ display:none; }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }
      .main{ padding:14px; }
      .content{ grid-template-columns: 1fr; }
      table{ min-width: 780px; }
      .mNav{
        display:flex; gap:10px; overflow:auto;
        padding:10px 2px 0;
        scrollbar-width:none;
      }
      .mNav::-webkit-scrollbar{ display:none; }
      .mNav button{
        flex:0 0 auto;
        border:1px solid var(--line);
        background: rgba(255,255,255,.02);
        color:var(--text);
        padding:10px 12px;
        border-radius:999px;
        cursor:pointer;
        transition: border-color .12s ease, background .12s ease;
        font-size:13px;
        display:flex; align-items:center; gap:10px;
      }
      .mNav button.active{ border-color: rgba(167,139,250,.55); background: rgba(124,58,237,.12); }
      .row2, .row3, .grid2, .grid3{ grid-template-columns: 1fr; }
    }
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; scroll-behavior:auto !important; }
    }
    @media print{
      body{ background:#fff; color:#000; }
      .sidebar, .topbar .actions, .mNav, .iconBtn, .btn{ display:none !important; }
      .card, .topbar{ box-shadow:none; border-color:#ddd; background:#fff; }
      .kpi{ border-color:#ddd; }
      th{ position:static; }
      table{ min-width:0; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">G</div>
        <div style="min-width:0">
          <h1>GazelBooks</h1>
          <p>Pembukuan UMKM ‚Ä¢ MVP Offline</p>
        </div>
      </div>

      <nav class="nav" id="nav"></nav>

      <div class="sideFooter">
        <div class="row">
          <div>
            <div style="font-weight:800; font-size:13px;">Mode: Offline</div>
            <div class="small">Data tersimpan di browser (LocalStorage). Cocok untuk demo sales & MVP cepat.</div>
          </div>
          <span class="chip" id="ver">v1.0</span>
        </div>
      </div>
    </aside>

    <main class="main">
      <section class="topbar">
        <div>
          <h2 id="pageTitle">Dashboard</h2>
          <p id="pageDesc">Ringkasan kas, profit, hutang/piutang, dan performa bisnis.</p>
          <div class="mNav" id="mNav"></div>
        </div>

        <div class="actions">
          <button class="btn" id="btnExport"><span>‚¨áÔ∏è</span> Export JSON</button>
          <button class="btn" id="btnImport"><span>‚¨ÜÔ∏è</span> Import JSON</button>
          <button class="btn" id="btnReset"><span>üß®</span> Reset Demo</button>
          <button class="btn primary" id="btnQuickAdd"><span>‚ûï</span> Transaksi</button>
        </div>
      </section>

      <section class="content" id="content"></section>
    </main>
  </div>

  <!-- Modal: Quick Add Transaction -->
  <div class="modalOverlay" id="modalTx">
    <div class="modal">
      <div class="mh">
        <div>
          <h3>Tambah Transaksi</h3>
          <p>Input cepat untuk pemasukan/pengeluaran. Otomatis masuk ke Buku Kas.</p>
        </div>
        <button class="iconBtn" id="closeTx" title="Tutup">‚úï</button>
      </div>
      <div class="mb">
        <form class="form" id="txForm">
          <div class="row3">
            <div class="field">
              <label>Tanggal</label>
              <input type="date" id="txDate" required />
            </div>
            <div class="field">
              <label>Jenis</label>
              <select id="txType" required>
                <option value="in">Pemasukan</option>
                <option value="out">Pengeluaran</option>
              </select>
            </div>
            <div class="field">
              <label>Jumlah (Rp)</label>
              <input type="number" id="txAmount" min="0" step="100" placeholder="contoh: 250000" required />
            </div>
          </div>

          <div class="row2">
            <div class="field">
              <label>Kategori</label>
              <select id="txCategory" required></select>
            </div>
            <div class="field">
              <label>Metode</label>
              <select id="txMethod" required>
                <option value="cash">Cash</option>
                <option value="bank">Transfer/Bank</option>
                <option value="ewallet">E-Wallet</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label>Keterangan</label>
            <input id="txNote" maxlength="120" placeholder="contoh: Pembelian bahan baku" />
          </div>

          <div class="row2">
            <button type="button" class="btn" id="btnTxCancel">Batal</button>
            <button type="submit" class="btn primary">Simpan Transaksi</button>
          </div>

          <div class="hintLine">Tips: Untuk UMKM, yang penting rapi dulu. Nanti baru upgrade ke jurnal akuntansi lengkap.</div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal: Invoice -->
  <div class="modalOverlay" id="modalInv">
    <div class="modal">
      <div class="mh">
        <div>
          <h3>Buat Invoice</h3>
          <p>Invoice sederhana + PDF print (via browser). Bisa ditandai "Paid".</p>
        </div>
        <button class="iconBtn" id="closeInv" title="Tutup">‚úï</button>
      </div>
      <div class="mb">
        <form class="form" id="invForm">
          <div class="row3">
            <div class="field">
              <label>Tanggal</label>
              <input type="date" id="invDate" required />
            </div>
            <div class="field">
              <label>Jatuh Tempo</label>
              <input type="date" id="invDue" required />
            </div>
            <div class="field">
              <label>No. Invoice</label>
              <input id="invNo" required placeholder="GB-INV-0001" />
            </div>
          </div>

          <div class="row2">
            <div class="field">
              <label>Nama Pelanggan</label>
              <input id="invCustomer" required placeholder="contoh: PT Maju Jaya" />
            </div>
            <div class="field">
              <label>Kontak (opsional)</label>
              <input id="invContact" placeholder="WA / Email" />
            </div>
          </div>

          <div class="row2">
            <div class="field">
              <label>Deskripsi</label>
              <input id="invDesc" required placeholder="contoh: Jasa desain & konten" />
            </div>
            <div class="field">
              <label>Total (Rp)</label>
              <input type="number" id="invTotal" min="0" step="100" required placeholder="contoh: 1500000" />
            </div>
          </div>

          <div class="row2">
            <button type="button" class="btn" id="btnInvCancel">Batal</button>
            <button type="submit" class="btn primary">Simpan Invoice</button>
          </div>

          <div class="hintLine">Invoice yang dibayar bisa otomatis menambah pemasukan ke Buku Kas.</div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal: Import -->
  <div class="modalOverlay" id="modalImport">
    <div class="modal">
      <div class="mh">
        <div>
          <h3>Import Data (JSON)</h3>
          <p>Tempel file JSON export dari GazelBooks untuk restore data.</p>
        </div>
        <button class="iconBtn" id="closeImport" title="Tutup">‚úï</button>
      </div>
      <div class="mb">
        <div class="form">
          <div class="field">
            <label>Tempel JSON</label>
            <textarea id="importArea" placeholder='{"version":"1.0","data":{...}}'></textarea>
          </div>
          <div class="row2">
            <button class="btn" id="btnImportCancel">Batal</button>
            <button class="btn primary" id="btnImportDo">Import</button>
          </div>
          <div class="hintLine">Catatan: Import akan menimpa data lama.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Add Debt -->
  <div class="modalOverlay" id="modalDebt">
    <div class="modal">
      <div class="mh">
        <div>
          <h3 id="debtTitle">Tambah</h3>
          <p>Catat hutang atau piutang. Bisa ditutup (paid) kapan saja.</p>
        </div>
        <button class="iconBtn" id="closeDebt" title="Tutup">‚úï</button>
      </div>
      <div class="mb">
        <form class="form" id="debtForm">
          <input type="hidden" id="debtKind" value="receivable" />
          <div class="row2">
            <div class="field">
              <label>Nama</label>
              <input id="debtName" required placeholder="contoh: Piutang dari Budi" />
            </div>
            <div class="field">
              <label>Pihak</label>
              <input id="debtParty" required placeholder="contoh: Budi" />
            </div>
          </div>
          <div class="row3">
            <div class="field">
              <label>Jatuh Tempo</label>
              <input type="date" id="debtDue" required />
            </div>
            <div class="field">
              <label>Jumlah (Rp)</label>
              <input type="number" id="debtAmount" min="0" step="100" required />
            </div>
            <div class="field">
              <label>Catatan</label>
              <input id="debtNote" placeholder="opsional" />
            </div>
          </div>
          <div class="row2">
            <button type="button" class="btn" id="btnDebtCancel">Batal</button>
            <button type="submit" class="btn primary">Simpan</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="t1" id="toastT1">Sukses</div>
    <div class="t2" id="toastT2">Data tersimpan.</div>
  </div>

<script>
/* GazelBooks MVP ‚Äî Offline Single Page App (No build tools)
   - LocalStorage persistence
   - Dashboard, Buku Kas, Invoice, Hutang/Piutang, Laporan, Kalkulator, Settings
*/
const APP_KEY = "gazelbooks_mvp_v1";
const VERSION = "1.0";

const rupiah = (n) => {
  const x = Number(n || 0);
  return x.toLocaleString("id-ID", { style:"currency", currency:"IDR", maximumFractionDigits:0 });
};
const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
const todayISO = () => {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
};
const parseDate = (iso) => {
  const [y,m,d] = String(iso||"").split("-").map(Number);
  if(!y || !m || !d) return new Date();
  return new Date(y, m-1, d, 12, 0, 0);
};
const fmtDate = (iso) => parseDate(iso).toLocaleDateString("id-ID", { day:"2-digit", month:"short", year:"numeric" });

const el = (id) => document.getElementById(id);

const showToast = (title, msg) => {
  const t = el("toast");
  el("toastT1").textContent = title;
  el("toastT2").textContent = msg;
  t.classList.add("open");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>t.classList.remove("open"), 2600);
};

const safeJSON = (s) => { try{ return JSON.parse(s);}catch(e){ return null; } };

const defaultData = () => {
  const now = todayISO();
  const month = new Date().toLocaleDateString("id-ID", { month:"long", year:"numeric" });
  return {
    version: VERSION,
    profile: { businessName:"Contoh UMKM", owner:"Owner", currency:"IDR", createdAt: Date.now() },
    categories: {
      in: ["Penjualan","Jasa","Modal","Pendapatan Lain"],
      out:["Bahan Baku","Operasional","Gaji","Transport","Marketing","Sewa","Listrik & Internet","Pajak","Lainnya"]
    },
    transactions: [
      { id: uid(), date: now, type:"in", category:"Penjualan", method:"cash", amount: 1250000, note:"Penjualan hari ini", createdAt: Date.now()-600000 },
      { id: uid(), date: now, type:"out", category:"Bahan Baku", method:"bank", amount: 420000, note:"Belanja bahan", createdAt: Date.now()-520000 },
      { id: uid(), date: now, type:"out", category:"Operasional", method:"ewallet", amount: 85000, note:"Internet", createdAt: Date.now()-420000 },
    ],
    invoices: [
      { id: uid(), no:"GB-INV-0001", date: now, due: now, customer:"PT Maju Jaya", contact:"", desc:"Jasa desain konten", total: 1500000, status:"unpaid", createdAt: Date.now()-320000 },
    ],
    receivables: [
      { id: uid(), name:"Piutang dari PT Maju Jaya", counterparty:"PT Maju Jaya", due: now, amount: 1500000, status:"open", note:"Invoice GB-INV-0001", createdAt: Date.now()-310000 },
    ],
    payables: [
      { id: uid(), name:"Hutang ke Supplier A", counterparty:"Supplier A", due: now, amount: 300000, status:"open", note:"Pembelian bahan", createdAt: Date.now()-210000 },
    ],
    settings: { monthLabel: month, defaultMethod:"cash", invoicePrefix:"GB-INV-", invoiceNext: 2 }
  };
};

const load = () => {
  const raw = localStorage.getItem(APP_KEY);
  if(!raw) return defaultData();
  const j = safeJSON(raw);
  if(!j || !j.version) return defaultData();
  return j;
};
let state = load();
const save = () => localStorage.setItem(APP_KEY, JSON.stringify(state, null, 2));

const NAV = [
  { id:"dashboard", title:"Dashboard", sub:"Ringkasan bisnis", icon:"üìä" },
  { id:"cashbook", title:"Buku Kas", sub:"Pemasukan & pengeluaran", icon:"üí∏" },
  { id:"invoices", title:"Invoice", sub:"Tagihan pelanggan", icon:"üßæ" },
  { id:"debts", title:"Hutang/Piutang", sub:"Jatuh tempo & status", icon:"‚è≥" },
  { id:"reports", title:"Laporan", sub:"Laba rugi & arus kas", icon:"üìÑ" },
  { id:"calculator", title:"Kalkulator", sub:"BEP, margin, cicilan", icon:"üßÆ" },
  { id:"settings", title:"Pengaturan", sub:"Profil & kategori", icon:"‚öôÔ∏è" },
];
let page = "dashboard";

const setPage = (id) => { page = id; render(); window.scrollTo({top:0, behavior:"smooth"}); };

const sumTx = (txs, type) => txs.filter(t=>t.type===type).reduce((a,b)=>a+Number(b.amount||0),0);
const getMonthRange = () => {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), 1, 0,0,0);
  const end = new Date(now.getFullYear(), now.getMonth()+1, 0, 23,59,59);
  return { start, end };
};
const within = (iso, start, end) => {
  const d = parseDate(iso);
  return d >= start && d <= end;
};

const calc = {
  txAll(){
    return [...state.transactions].sort((a,b)=> parseDate(b.date) - parseDate(a.date) || (b.createdAt||0)-(a.createdAt||0));
  },
  txThisMonth(){
    const {start,end} = getMonthRange();
    return calc.txAll().filter(t=>within(t.date,start,end));
  },
  invoicesAll(){
    return [...state.invoices].sort((a,b)=> parseDate(b.date) - parseDate(a.date) || (b.createdAt||0)-(a.createdAt||0));
  },
  receivablesOpen(){ return state.receivables.filter(r=>r.status==="open"); },
  payablesOpen(){ return state.payables.filter(p=>p.status==="open"); },
  kpis(){
    const txm = calc.txThisMonth();
    const inc = sumTx(txm,"in");
    const out = sumTx(txm,"out");
    const profit = inc - out;
    const ar = calc.receivablesOpen().reduce((a,b)=>a+Number(b.amount||0),0);
    const ap = calc.payablesOpen().reduce((a,b)=>a+Number(b.amount||0),0);
    return { inc, out, profit, ar, ap, txCount: txm.length };
  },
  cashBalance(){
    const inc = sumTx(state.transactions,"in");
    const out = sumTx(state.transactions,"out");
    return inc - out;
  },
  dueSoon(list, days=7){
    const now = new Date();
    const lim = new Date(now.getFullYear(), now.getMonth(), now.getDate()+days, 23,59,59);
    return list
      .filter(x=>x.status==="open")
      .filter(x=> parseDate(x.due) <= lim)
      .sort((a,b)=> parseDate(a.due)-parseDate(b.due));
  }
};

const escapeHTML = (s="") => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));

const openModal = (id) => el(id).classList.add("open");
const closeModal = (id) => el(id).classList.remove("open");

const setTop = (title, desc) => { el("pageTitle").textContent = title; el("pageDesc").textContent = desc; };

const svgSpark = (values=[]) => {
  const w=160, h=44, pad=6;
  if(!values.length) values=[0];
  const min = Math.min(...values);
  const max = Math.max(...values);
  const span = Math.max(1, max-min);
  const pts = values.map((v,i)=>{
    const x = pad + (i*(w-2*pad))/Math.max(1, values.length-1);
    const y = pad + (h-2*pad) * (1 - ((v-min)/span));
    return [x,y];
  });
  const d = pts.map((p,i)=> (i?"L":"M") + p[0].toFixed(1)+" "+p[1].toFixed(1)).join(" ");
  return `
    <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="${d}" stroke="rgba(167,139,250,.9)" stroke-width="2.2" stroke-linecap="round" />
      <path d="${d} L ${w-pad} ${h-pad} L ${pad} ${h-pad} Z" fill="rgba(124,58,237,.12)" />
    </svg>
  `;
};

/* CRUD */
function addTransaction(tx){
  state.transactions.push({ id: uid(), createdAt: Date.now(), ...tx, amount:Number(tx.amount||0) });
  save(); showToast("Sukses","Transaksi tersimpan ke Buku Kas."); render();
}
function deleteTransaction(id){
  state.transactions = state.transactions.filter(t=>t.id!==id);
  save(); showToast("Dihapus","Transaksi berhasil dihapus."); render();
}
function addInvoice(inv){
  state.invoices.push({ id: uid(), createdAt: Date.now(), status:"unpaid", ...inv, total:Number(inv.total||0) });
  state.receivables.push({
    id: uid(), name:`Piutang dari ${inv.customer}`, counterparty: inv.customer, due: inv.due,
    amount:Number(inv.total||0), status:"open", note:`Invoice ${inv.no}`, createdAt: Date.now()
  });
  save(); showToast("Sukses","Invoice tersimpan. Piutang otomatis dibuat."); render();
}
function markInvoicePaid(id){
  const inv = state.invoices.find(i=>i.id===id);
  if(!inv || inv.status==="paid") return;
  inv.status="paid"; inv.paidAt=Date.now();
  const r = state.receivables.find(x=>x.note===`Invoice ${inv.no}` && x.status==="open");
  if(r) r.status="closed";
  state.transactions.push({
    id: uid(), createdAt: Date.now(), date: todayISO(), type:"in", category:"Jasa", method:"bank",
    amount:Number(inv.total||0), note:`Pembayaran invoice ${inv.no} (${inv.customer})`
  });
  save(); showToast("Paid","Invoice dibayar + pemasukan masuk ke Buku Kas."); render();
}
function deleteInvoice(id){
  const inv = state.invoices.find(i=>i.id===id);
  state.invoices = state.invoices.filter(i=>i.id!==id);
  if(inv) state.receivables = state.receivables.filter(r=>r.note !== `Invoice ${inv.no}`);
  save(); showToast("Dihapus","Invoice & piutang terkait dihapus."); render();
}
function addDebtItem(kind, item){
  const arr = kind==="receivable" ? state.receivables : state.payables;
  arr.push({ id: uid(), createdAt: Date.now(), status:"open", ...item, amount:Number(item.amount||0) });
  save(); showToast("Sukses", kind==="receivable" ? "Piutang ditambahkan." : "Hutang ditambahkan."); render();
}
function closeDebtItem(kind, id){
  const arr = kind==="receivable" ? state.receivables : state.payables;
  const x = arr.find(i=>i.id===id);
  if(!x) return;
  x.status="closed"; x.closedAt=Date.now();
  if(kind==="receivable"){
    state.transactions.push({ id: uid(), createdAt: Date.now(), date: todayISO(), type:"in", category:"Pendapatan Lain", method:"bank", amount:Number(x.amount||0), note:`Pelunasan piutang (${x.counterparty})` });
  }else{
    state.transactions.push({ id: uid(), createdAt: Date.now(), date: todayISO(), type:"out", category:"Operasional", method:"bank", amount:Number(x.amount||0), note:`Pembayaran hutang (${x.counterparty})` });
  }
  save(); showToast("Selesai", kind==="receivable" ? "Piutang ditutup + pemasukan dicatat." : "Hutang ditutup + pengeluaran dicatat."); render();
}
function deleteDebtItem(kind, id){
  if(kind==="receivable") state.receivables = state.receivables.filter(i=>i.id!==id);
  else state.payables = state.payables.filter(i=>i.id!==id);
  save(); showToast("Dihapus", kind==="receivable" ? "Piutang dihapus." : "Hutang dihapus."); render();
}

/* Pages */
function pageDashboard(){
  setTop("Dashboard","Ringkasan kas, profit, hutang/piutang, dan performa bisnis.");
  const k = calc.kpis();
  const bal = calc.cashBalance();

  const days = 14;
  const series = [];
  for(let i=days-1;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate()-i);
    const iso = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    const list = state.transactions.filter(t=>t.date===iso);
    const inc = sumTx(list,"in");
    const out = sumTx(list,"out");
    series.push(inc - out);
  }
  const dueAR = calc.dueSoon(state.receivables,7);
  const dueAP = calc.dueSoon(state.payables,7);

  return `
    <div class="card">
      <div class="hd">
        <div>
          <h3>Ringkasan Bulan Ini</h3>
          <div class="muted">${state.settings.monthLabel} ‚Ä¢ ${k.txCount} transaksi</div>
        </div>
        <span class="chip">saldo: ${rupiah(bal)}</span>
      </div>
      <div class="bd">
        <div class="grid3">
          <div class="kpi good">
            <div class="label">Pemasukan</div>
            <div class="val">${rupiah(k.inc)}</div>
            <div class="hint">Total kas masuk bulan ini</div>
          </div>
          <div class="kpi bad">
            <div class="label">Pengeluaran</div>
            <div class="val">${rupiah(k.out)}</div>
            <div class="hint">Total kas keluar bulan ini</div>
          </div>
          <div class="kpi">
            <div class="label">Profit Estimasi</div>
            <div class="val">${rupiah(k.profit)}</div>
            <div class="hint">(pemasukan - pengeluaran)</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="grid2">
          <div class="kpi">
            <div class="label">Piutang (Open)</div>
            <div class="val">${rupiah(k.ar)}</div>
            <div class="hint">Tagihan pelanggan yang belum dibayar</div>
          </div>
          <div class="kpi">
            <div class="label">Hutang (Open)</div>
            <div class="val">${rupiah(k.ap)}</div>
            <div class="hint">Kewajiban ke supplier / pihak lain</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="kpi">
          <div class="label">Tren 14 Hari (Net Cashflow)</div>
          <div style="margin-top:10px">${svgSpark(series)}</div>
          <div class="hint">Grafik kecil untuk melihat arah kas.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <h3>Jatuh Tempo 7 Hari</h3>
          <div class="muted">Pantau piutang & hutang yang dekat deadline</div>
        </div>
        <button class="btn" onclick="setPage('debts')">Buka Hutang/Piutang</button>
      </div>
      <div class="bd">
        <div class="grid2">
          <div class="kpi">
            <div class="label">Piutang segera jatuh tempo</div>
            <div class="val">${dueAR.length}</div>
            <div class="hint">${dueAR.length? "Ada yang perlu ditagih." : "Aman. Tidak ada."}</div>
          </div>
          <div class="kpi">
            <div class="label">Hutang segera jatuh tempo</div>
            <div class="val">${dueAP.length}</div>
            <div class="hint">${dueAP.length? "Perlu disiapkan dana." : "Aman. Tidak ada."}</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Jenis</th>
                <th>Nama</th>
                <th>Pihak</th>
                <th>Jatuh Tempo</th>
                <th>Jumlah</th>
              </tr>
            </thead>
            <tbody>
              ${
                [...dueAR.map(x=>({kind:"Piutang",...x})), ...dueAP.map(x=>({kind:"Hutang",...x}))]
                  .sort((a,b)=> parseDate(a.due)-parseDate(b.due))
                  .slice(0,8)
                  .map(x=>`
                    <tr>
                      <td><span class="badge ${x.kind==='Piutang'?'in':'out'}">${x.kind}</span></td>
                      <td>${escapeHTML(x.name)}</td>
                      <td>${escapeHTML(x.counterparty)}</td>
                      <td class="mono">${fmtDate(x.due)}</td>
                      <td class="mono">${rupiah(x.amount)}</td>
                    </tr>
                  `).join("")
                || `<tr><td colspan="5" style="color:var(--muted)">Tidak ada data jatuh tempo dekat.</td></tr>`
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
}

function rowTx(t){
  const b = t.type === "in" ? "in" : "out";
  const label = t.type === "in" ? "Pemasukan" : "Pengeluaran";
  const methodLabel = t.method === "cash" ? "Cash" : t.method === "bank" ? "Bank" : "E-Wallet";
  return `
    <tr data-id="${t.id}">
      <td class="mono">${fmtDate(t.date)}</td>
      <td><span class="badge ${b}">${label}</span></td>
      <td>${escapeHTML(t.category || "-")}</td>
      <td>${methodLabel}</td>
      <td>${escapeHTML(t.note || "")}</td>
      <td class="mono">${rupiah(t.amount)}</td>
      <td>
        <div class="tdActions">
          <button class="iconBtn danger" title="Hapus" onclick="deleteTransaction('${t.id}')">üóëÔ∏è</button>
        </div>
      </td>
    </tr>
  `;
}

function cashbookInsights(){
  const tx = calc.txThisMonth();
  const inc = sumTx(tx,"in");
  const out = sumTx(tx,"out");
  const byCat = {};
  tx.filter(t=>t.type==="out").forEach(t=> byCat[t.category] = (byCat[t.category]||0) + Number(t.amount||0));
  const top = Object.entries(byCat).sort((a,b)=>b[1]-a[1]).slice(0,5);

  const burnRate = out; // monthly
  const balance = calc.cashBalance();
  const runway = burnRate>0 ? (balance / burnRate) : 999;

  return `
    <div class="grid2">
      <div class="kpi">
        <div class="label">Rasio Profit</div>
        <div class="val">${inc>0 ? Math.round(((inc-out)/inc)*100) : 0}%</div>
        <div class="hint">Profit / pemasukan (bulan ini)</div>
      </div>
      <div class="kpi">
        <div class="label">Cash Runway</div>
        <div class="val">${runway>=999 ? "‚àû" : runway.toFixed(1)} bln</div>
        <div class="hint">Saldo / pengeluaran bulan ini</div>
      </div>
    </div>
    <div style="height:12px"></div>
    <div class="kpi">
      <div class="label">Top Pengeluaran (bulan ini)</div>
      <div style="margin-top:10px; display:grid; gap:8px">
        ${
          top.length ? top.map(([c,v])=>`
            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px">
              <div style="font-weight:700">${escapeHTML(c)}</div>
              <div class="mono">${rupiah(v)}</div>
            </div>
          `).join("") : `<div style="color:var(--muted)">Belum ada pengeluaran bulan ini.</div>`
        }
      </div>
    </div>
  `;
}

function pageCashbook(){
  setTop("Buku Kas","Semua pemasukan & pengeluaran. Bisa filter dan export.");
  const tx = calc.txAll();
  return `
    <div class="card">
      <div class="hd">
        <div>
          <h3>Transaksi</h3>
          <div class="muted">${tx.length} data ‚Ä¢ tersimpan offline</div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn" onclick="openQuickAdd()">‚ûï Tambah</button>
          <button class="btn" onclick="exportCSV()">üìÑ Export CSV</button>
          <button class="btn" onclick="window.print()">üñ®Ô∏è Print</button>
        </div>
      </div>
      <div class="bd">
        <div class="row3">
          <div class="field">
            <label>Filter Jenis</label>
            <select id="fType">
              <option value="all">Semua</option>
              <option value="in">Pemasukan</option>
              <option value="out">Pengeluaran</option>
            </select>
          </div>
          <div class="field">
            <label>Filter Kategori</label>
            <select id="fCat">
              <option value="all">Semua</option>
              ${[...new Set([...state.categories.in, ...state.categories.out])].map(c=>`<option value="${escapeHTML(c)}">${escapeHTML(c)}</option>`).join("")}
            </select>
          </div>
          <div class="field">
            <label>Cari</label>
            <input id="fSearch" placeholder="note / kategori / metode" />
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>Jenis</th>
                <th>Kategori</th>
                <th>Metode</th>
                <th>Keterangan</th>
                <th>Jumlah</th>
                <th style="text-align:right">Aksi</th>
              </tr>
            </thead>
            <tbody id="txBody">
              ${tx.map(t=>rowTx(t)).join("")}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <h3>Insight Cepat</h3>
          <div class="muted">Analisis sederhana untuk UMKM</div>
        </div>
        <span class="chip">saldo total: ${rupiah(calc.cashBalance())}</span>
      </div>
      <div class="bd">${cashbookInsights()}</div>
    </div>
  `;
}

function pageInvoices(){
  setTop("Invoice","Buat invoice sederhana, tandai paid, dan otomatis catat pemasukan.");
  const inv = calc.invoicesAll();
  return `
    <div class="card">
      <div class="hd">
        <div>
          <h3>Daftar Invoice</h3>
          <div class="muted">${inv.length} invoice</div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn" onclick="openInvoice()">‚ûï Buat Invoice</button>
          <button class="btn" onclick="window.print()">üñ®Ô∏è Print</button>
        </div>
      </div>
      <div class="bd">
        <div class="tableWrap">
          <table style="min-width: 920px">
            <thead>
              <tr>
                <th>No</th>
                <th>Tanggal</th>
                <th>Pelanggan</th>
                <th>Deskripsi</th>
                <th>Jatuh Tempo</th>
                <th>Total</th>
                <th>Status</th>
                <th style="text-align:right">Aksi</th>
              </tr>
            </thead>
            <tbody>
              ${
                inv.map(i=>{
                  const st = i.status==="paid" ? `<span class="badge in">Paid</span>` : `<span class="badge out">Unpaid</span>`;
                  return `
                    <tr>
                      <td class="mono">${escapeHTML(i.no)}</td>
                      <td class="mono">${fmtDate(i.date)}</td>
                      <td>${escapeHTML(i.customer)}</td>
                      <td>${escapeHTML(i.desc)}</td>
                      <td class="mono">${fmtDate(i.due)}</td>
                      <td class="mono">${rupiah(i.total)}</td>
                      <td>${st}</td>
                      <td>
                        <div class="tdActions">
                          ${i.status!=="paid" ? `<button class="iconBtn" title="Mark Paid" onclick="markInvoicePaid('${i.id}')">‚úÖ</button>` : `<button class="iconBtn" title="Paid" disabled style="opacity:.45; cursor:not-allowed">‚úÖ</button>`}
                          <button class="iconBtn danger" title="Hapus" onclick="deleteInvoice('${i.id}')">üóëÔ∏è</button>
                        </div>
                      </td>
                    </tr>
                  `;
                }).join("")
                || `<tr><td colspan="8" style="color:var(--muted)">Belum ada invoice.</td></tr>`
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <h3>Catatan</h3>
          <div class="muted">Invoice terhubung ke Piutang & Buku Kas</div>
        </div>
        <span class="chip">auto</span>
      </div>
      <div class="bd">
        <div class="hintLine">
          ‚Ä¢ Saat invoice dibuat ‚Üí otomatis membuat Piutang.<br/>
          ‚Ä¢ Saat invoice dibayar ‚Üí otomatis menutup Piutang + membuat pemasukan di Buku Kas.
        </div>
      </div>
    </div>
  `;
}

function pageDebts(){
  setTop("Hutang / Piutang","Pantau kewajiban & tagihan. Bisa ditutup dan otomatis buat transaksi.");
  const ar = [...state.receivables].sort((a,b)=> parseDate(a.due)-parseDate(b.due));
  const ap = [...state.payables].sort((a,b)=> parseDate(a.due)-parseDate(b.due));
  const arOpen = ar.filter(x=>x.status==="open").reduce((a,b)=>a+Number(b.amount||0),0);
  const apOpen = ap.filter(x=>x.status==="open").reduce((a,b)=>a+Number(b.amount||0),0);

  const row = (x, kind) => `
    <tr>
      <td>${escapeHTML(x.name)}</td>
      <td>${escapeHTML(x.counterparty)}</td>
      <td class="mono">${fmtDate(x.due)}</td>
      <td class="mono">${rupiah(x.amount)}</td>
      <td>${x.status==="open" ? `<span class="badge ${kind==="receivable"?"in":"out"}">Open</span>` : `<span class="badge">Closed</span>`}</td>
      <td>
        <div class="tdActions">
          ${x.status==="open" ? `<button class="iconBtn" title="Tutup" onclick="closeDebtItem('${kind}','${x.id}')">üîí</button>` : `<button class="iconBtn" disabled style="opacity:.45; cursor:not-allowed">üîí</button>`}
          <button class="iconBtn danger" title="Hapus" onclick="deleteDebtItem('${kind}','${x.id}')">üóëÔ∏è</button>
        </div>
      </td>
    </tr>
  `;

  return `
    <div class="card">
      <div class="hd">
        <div>
          <h3>Ringkasan</h3>
          <div class="muted">Open amounts</div>
        </div>
        <span class="chip">piutang: ${rupiah(arOpen)} ‚Ä¢ hutang: ${rupiah(apOpen)}</span>
      </div>
      <div class="bd">
        <div class="grid2">
          <div class="kpi">
            <div class="label">Piutang Open</div>
            <div class="val">${rupiah(arOpen)}</div>
            <div class="hint">Total tagihan yang belum dibayar</div>
          </div>
          <div class="kpi">
            <div class="label">Hutang Open</div>
            <div class="val">${rupiah(apOpen)}</div>
            <div class="hint">Total kewajiban yang belum dibayar</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <h3>Piutang</h3>
          <div class="muted">${ar.length} data</div>
        </div>
        <button class="btn" onclick="openDebt('receivable')">‚ûï Tambah Piutang</button>
      </div>
      <div class="bd">
        <div class="tableWrap">
          <table style="min-width: 920px">
            <thead>
              <tr>
                <th>Nama</th>
                <th>Pihak</th>
                <th>Jatuh Tempo</th>
                <th>Jumlah</th>
                <th>Status</th>
                <th style="text-align:right">Aksi</th>
              </tr>
            </thead>
            <tbody>
              ${ar.map(x=>row(x,"receivable")).join("") || `<tr><td colspan="6" style="color:var(--muted)">Belum ada piutang.</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <h3>Hutang</h3>
          <div class="muted">${ap.length} data</div>
        </div>
        <button class="btn" onclick="openDebt('payable')">‚ûï Tambah Hutang</button>
      </div>
      <div class="bd">
        <div class="tableWrap">
          <table style="min-width: 920px">
            <thead>
              <tr>
                <th>Nama</th>
                <th>Pihak</th>
                <th>Jatuh Tempo</th>
                <th>Jumlah</th>
                <th>Status</th>
                <th style="text-align:right">Aksi</th>
              </tr>
            </thead>
            <tbody>
              ${ap.map(x=>row(x,"payable")).join("") || `<tr><td colspan="6" style="color:var(--muted)">Belum ada hutang.</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
}

function pageReports(){
  setTop("Laporan","Laba rugi sederhana, arus kas, dan ringkasan kategori.");
  const txm = calc.txThisMonth();
  const inc = sumTx(txm,"in");
  const out = sumTx(txm,"out");
  const profit = inc - out;

  const byIn = {};
  const byOut = {};
  txm.forEach(t=>{
    const bag = t.type==="in" ? byIn : byOut;
    bag[t.category] = (bag[t.category]||0) + Number(t.amount||0);
  });

  const listBlock = (obj, kind) => {
    const entries = Object.entries(obj).sort((a,b)=>b[1]-a[1]);
    return `
      <div class="kpi">
        <div class="label">${kind}</div>
        <div style="margin-top:10px; display:grid; gap:8px">
          ${entries.length ? entries.map(([k,v])=>`
            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px">
              <div style="font-weight:700">${escapeHTML(k)}</div>
              <div class="mono">${rupiah(v)}</div>
            </div>
          `).join("") : `<div style="color:var(--muted)">Tidak ada data.</div>`}
        </div>
      </div>
    `;
  };

  return `
    <div class="card">
      <div class="hd">
        <div>
          <h3>Laporan Bulan Ini</h3>
          <div class="muted">${state.settings.monthLabel}</div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn" onclick="exportReportCSV()">üìÑ Export Laporan CSV</button>
          <button class="btn" onclick="window.print()">üñ®Ô∏è Print</button>
        </div>
      </div>
      <div class="bd">
        <div class="grid3">
          <div class="kpi good">
            <div class="label">Total Pemasukan</div>
            <div class="val">${rupiah(inc)}</div>
            <div class="hint">Bulan ini</div>
          </div>
          <div class="kpi bad">
            <div class="label">Total Pengeluaran</div>
            <div class="val">${rupiah(out)}</div>
            <div class="hint">Bulan ini</div>
          </div>
          <div class="kpi">
            <div class="label">Laba/Rugi</div>
            <div class="val">${rupiah(profit)}</div>
            <div class="hint">Estimasi sederhana</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="grid2">
          ${listBlock(byIn,"Pemasukan per Kategori")}
          ${listBlock(byOut,"Pengeluaran per Kategori")}
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <h3>Arus Kas</h3>
          <div class="muted">Saldo akhir = total pemasukan - total pengeluaran</div>
        </div>
        <span class="chip">saldo total: ${rupiah(calc.cashBalance())}</span>
      </div>
      <div class="bd">
        <div class="hintLine">
          Catatan: Ini laporan kas sederhana (cash basis). Untuk akuntansi penuh (accrual, jurnal, neraca), nanti upgrade versi SaaS.
        </div>
      </div>
    </div>
  `;
}

function pageCalculator(){
  setTop("Kalkulator Keuangan","BEP, margin, proyeksi profit, dan simulasi cicilan.");
  return `
    <div class="card">
      <div class="hd">
        <div>
          <h3>Margin & Harga Jual</h3>
          <div class="muted">Hitung harga jual berdasarkan HPP + target margin</div>
        </div>
        <span class="chip">UMKM</span>
      </div>
      <div class="bd">
        <div class="row3">
          <div class="field">
            <label>HPP / Biaya (Rp)</label>
            <input type="number" id="cHpp" min="0" step="100" value="10000" />
          </div>
          <div class="field">
            <label>Target Margin (%)</label>
            <input type="number" id="cMargin" min="0" step="1" value="40" />
          </div>
          <div class="field">
            <label>Harga Jual (Rp)</label>
            <input type="text" id="cPrice" readonly />
          </div>
        </div>
        <div style="height:10px"></div>
        <button class="btn primary" onclick="calcMargin()">Hitung</button>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <h3>Break Even Point (BEP)</h3>
          <div class="muted">BEP unit = biaya tetap / (harga jual - biaya variabel)</div>
        </div>
        <span class="chip">BEP</span>
      </div>
      <div class="bd">
        <div class="row3">
          <div class="field">
            <label>Biaya Tetap Bulanan (Rp)</label>
            <input type="number" id="bFixed" min="0" step="1000" value="3000000" />
          </div>
          <div class="field">
            <label>Harga Jual per Unit (Rp)</label>
            <input type="number" id="bPrice" min="0" step="100" value="25000" />
          </div>
          <div class="field">
            <label>Biaya Variabel per Unit (Rp)</label>
            <input type="number" id="bVar" min="0" step="100" value="12000" />
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="row2">
          <button class="btn primary" onclick="calcBEP()">Hitung BEP</button>
          <div class="kpi">
            <div class="label">BEP (Unit)</div>
            <div class="val" id="bRes">-</div>
            <div class="hint">Minimal unit terjual untuk balik modal</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <h3>Simulasi Cicilan</h3>
          <div class="muted">Perkiraan cicilan pinjaman (flat sederhana)</div>
        </div>
        <span class="chip">Loan</span>
      </div>
      <div class="bd">
        <div class="row3">
          <div class="field">
            <label>Pinjaman (Rp)</label>
            <input type="number" id="lPrincipal" min="0" step="100000" value="10000000" />
          </div>
          <div class="field">
            <label>Bunga per Tahun (%)</label>
            <input type="number" id="lRate" min="0" step="0.1" value="12" />
          </div>
          <div class="field">
            <label>Tenor (bulan)</label>
            <input type="number" id="lMonths" min="1" step="1" value="12" />
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="row2">
          <button class="btn primary" onclick="calcLoan()">Hitung Cicilan</button>
          <div class="kpi">
            <div class="label">Estimasi Cicilan/Bulan</div>
            <div class="val" id="lRes">-</div>
            <div class="hint">Estimasi sederhana untuk planning kas</div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function pageSettings(){
  setTop("Pengaturan","Profil bisnis, kategori, dan reset data.");
  const catsIn = state.categories.in;
  const catsOut = state.categories.out;
  return `
    <div class="card">
      <div class="hd">
        <div>
          <h3>Profil Bisnis</h3>
          <div class="muted">Nama usaha & owner</div>
        </div>
        <span class="chip">offline</span>
      </div>
      <div class="bd">
        <div class="row2">
          <div class="field">
            <label>Nama Bisnis</label>
            <input id="sBiz" value="${escapeHTML(state.profile.businessName)}" />
          </div>
          <div class="field">
            <label>Nama Owner</label>
            <input id="sOwner" value="${escapeHTML(state.profile.owner)}" />
          </div>
        </div>
        <div style="height:10px"></div>
        <button class="btn primary" onclick="saveProfile()">Simpan Profil</button>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <h3>Kategori</h3>
          <div class="muted">Edit kategori pemasukan & pengeluaran</div>
        </div>
        <span class="chip">comma</span>
      </div>
      <div class="bd">
        <div class="row2">
          <div class="field">
            <label>Kategori Pemasukan (pisahkan dengan koma)</label>
            <textarea id="sCatIn">${escapeHTML(catsIn.join(", "))}</textarea>
          </div>
          <div class="field">
            <label>Kategori Pengeluaran (pisahkan dengan koma)</label>
            <textarea id="sCatOut">${escapeHTML(catsOut.join(", "))}</textarea>
          </div>
        </div>
        <div style="height:10px"></div>
        <button class="btn primary" onclick="saveCats()">Simpan Kategori</button>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <h3>Data</h3>
          <div class="muted">Backup & restore</div>
        </div>
        <span class="chip">JSON</span>
      </div>
      <div class="bd">
        <div class="row2">
          <button class="btn" onclick="doExport()">‚¨áÔ∏è Export JSON</button>
          <button class="btn" onclick="openImport()">‚¨ÜÔ∏è Import JSON</button>
        </div>
        <div style="height:10px"></div>
        <button class="btn danger" onclick="resetDemo()">üß® Reset ke Demo</button>
      </div>
    </div>
  `;
}

/* Actions */
function buildNav(){
  const nav = el("nav");
  const mNav = el("mNav");
  nav.innerHTML = "";
  mNav.innerHTML = "";
  NAV.forEach(item=>{
    const b = document.createElement("button");
    b.className = page===item.id ? "active" : "";
    b.innerHTML = `
      <div class="left">
        <div class="ico">${item.icon}</div>
        <div style="min-width:0">
          <div class="title">${item.title}</div>
          <span class="sub">${item.sub}</span>
        </div>
      </div>
      <span class="chip">${item.id}</span>
    `;
    b.addEventListener("click", ()=>setPage(item.id));
    nav.appendChild(b);

    const mb = document.createElement("button");
    mb.className = page===item.id ? "active" : "";
    mb.innerHTML = `${item.icon} ${item.title}`;
    mb.addEventListener("click", ()=>setPage(item.id));
    mNav.appendChild(mb);
  });
}

function render(){
  buildNav();
  const content = el("content");
  content.innerHTML = ({
    dashboard: pageDashboard,
    cashbook: pageCashbook,
    invoices: pageInvoices,
    debts: pageDebts,
    reports: pageReports,
    calculator: pageCalculator,
    settings: pageSettings,
  }[page] || pageDashboard)();

  // page hooks
  if(page==="cashbook"){
    const apply = () => {
      const type = el("fType").value;
      const cat = el("fCat").value;
      const q = (el("fSearch").value||"").toLowerCase();
      const rows = calc.txAll().filter(t=>{
        if(type!=="all" && t.type!==type) return false;
        if(cat!=="all" && t.category!==cat) return false;
        const hay = `${t.note||""} ${t.category||""} ${t.method||""}`.toLowerCase();
        if(q && !hay.includes(q)) return false;
        return true;
      });
      el("txBody").innerHTML = rows.map(rowTx).join("") || `<tr><td colspan="7" style="color:var(--muted)">Tidak ada data.</td></tr>`;
    };
    el("fType").addEventListener("change", apply);
    el("fCat").addEventListener("change", apply);
    el("fSearch").addEventListener("input", apply);
  }

  if(page==="calculator"){
    calcMargin(); // auto
  }
}

function fillTxCategories(){
  const type = el("txType").value;
  const list = type==="in" ? state.categories.in : state.categories.out;
  el("txCategory").innerHTML = list.map(c=>`<option value="${escapeHTML(c)}">${escapeHTML(c)}</option>`).join("");
}
function openQuickAdd(){
  el("txDate").value = todayISO();
  el("txType").value = "in";
  el("txAmount").value = "";
  el("txNote").value = "";
  el("txMethod").value = state.settings.defaultMethod || "cash";
  fillTxCategories();
  openModal("modalTx");
  setTimeout(()=>el("txAmount").focus(), 50);
}
function openInvoice(){
  el("invDate").value = todayISO();
  el("invDue").value = todayISO();
  const n = String(state.settings.invoiceNext||1).padStart(4,"0");
  el("invNo").value = `${state.settings.invoicePrefix||"GB-INV-"}${n}`;
  el("invCustomer").value = "";
  el("invContact").value = "";
  el("invDesc").value = "";
  el("invTotal").value = "";
  openModal("modalInv");
  setTimeout(()=>el("invCustomer").focus(), 50);
}
function openDebt(kind){
  el("debtKind").value = kind;
  el("debtTitle").textContent = kind==="receivable" ? "Tambah Piutang" : "Tambah Hutang";
  el("debtName").value = "";
  el("debtParty").value = "";
  el("debtDue").value = todayISO();
  el("debtAmount").value = "";
  el("debtNote").value = "";
  openModal("modalDebt");
  setTimeout(()=>el("debtName").focus(), 50);
}

/* Export/Import */
function doExport(){
  const payload = { version: VERSION, exportedAt: Date.now(), data: state };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `gazelbooks-export-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  showToast("Export","File JSON sudah diunduh.");
}
function openImport(){
  el("importArea").value = "";
  openModal("modalImport");
}
function doImport(){
  const raw = el("importArea").value.trim();
  const j = safeJSON(raw);
  if(!j || !j.data){ showToast("Gagal","JSON tidak valid."); return; }
  state = j.data;
  save();
  closeModal("modalImport");
  showToast("Import","Data berhasil di-restore.");
  render();
}

function exportCSV(){
  const rows = calc.txAll();
  const header = ["date","type","category","method","amount","note"];
  const lines = [header.join(",")].concat(rows.map(r=>{
    const row = [
      r.date,
      r.type,
      `"${String(r.category||"").replace(/"/g,'""')}"`,
      r.method,
      r.amount,
      `"${String(r.note||"").replace(/"/g,'""')}"`
    ];
    return row.join(",");
  }));
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `gazelbooks-transactions-${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  showToast("Export","CSV transaksi diunduh.");
}

function exportReportCSV(){
  const txm = calc.txThisMonth();
  const inc = sumTx(txm,"in");
  const out = sumTx(txm,"out");
  const profit = inc - out;
  const lines = [
    "metric,value",
    `income,${inc}`,
    `expense,${out}`,
    `profit,${profit}`,
    "",
    "transactions_month,count",
    `tx,${txm.length}`
  ];
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `gazelbooks-report-${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  showToast("Export","CSV laporan diunduh.");
}

/* Calculator */
function calcMargin(){
  const hpp = Number(el("cHpp").value||0);
  const margin = Number(el("cMargin").value||0);
  const price = margin>=100 ? 0 : Math.round(hpp / (1 - margin/100));
  el("cPrice").value = rupiah(price);
}
function calcBEP(){
  const fixed = Number(el("bFixed").value||0);
  const price = Number(el("bPrice").value||0);
  const vari = Number(el("bVar").value||0);
  const contrib = price - vari;
  const unit = contrib>0 ? Math.ceil(fixed / contrib) : 0;
  el("bRes").textContent = unit ? `${unit.toLocaleString("id-ID")} unit` : "-";
}
function calcLoan(){
  const p = Number(el("lPrincipal").value||0);
  const r = Number(el("lRate").value||0)/100;
  const m = Number(el("lMonths").value||1);
  const monthlyInterest = (p * r) / 12;
  const installment = (p / m) + monthlyInterest; // simple flat
  el("lRes").textContent = rupiah(Math.round(installment));
}

/* Settings */
function saveProfile(){
  state.profile.businessName = el("sBiz").value.trim() || "UMKM";
  state.profile.owner = el("sOwner").value.trim() || "Owner";
  save(); showToast("Sukses","Profil disimpan."); render();
}
function saveCats(){
  const parse = (s) => (s||"").split(",").map(x=>x.trim()).filter(Boolean).slice(0,30);
  state.categories.in = parse(el("sCatIn").value);
  state.categories.out = parse(el("sCatOut").value);
  save(); showToast("Sukses","Kategori disimpan."); render();
}
function resetDemo(){
  if(!confirm("Reset data ke demo? Semua data akan hilang.")) return;
  state = defaultData();
  save();
  showToast("Reset","Data kembali ke demo.");
  render();
}

/* Modal wiring */
el("btnQuickAdd").addEventListener("click", openQuickAdd);
el("btnExport").addEventListener("click", doExport);
el("btnImport").addEventListener("click", openImport);
el("btnReset").addEventListener("click", resetDemo);

el("closeTx").addEventListener("click", ()=>closeModal("modalTx"));
el("btnTxCancel").addEventListener("click", ()=>closeModal("modalTx"));
el("txType").addEventListener("change", fillTxCategories);

el("txForm").addEventListener("submit", (e)=>{
  e.preventDefault();
  const tx = {
    date: el("txDate").value,
    type: el("txType").value,
    amount: Number(el("txAmount").value||0),
    category: el("txCategory").value,
    method: el("txMethod").value,
    note: el("txNote").value.trim()
  };
  if(!tx.date || !tx.amount || tx.amount<=0) return showToast("Gagal","Tanggal & jumlah wajib.");
  addTransaction(tx);
  closeModal("modalTx");
});

el("closeInv").addEventListener("click", ()=>closeModal("modalInv"));
el("btnInvCancel").addEventListener("click", ()=>closeModal("modalInv"));
el("invForm").addEventListener("submit", (e)=>{
  e.preventDefault();
  const inv = {
    no: el("invNo").value.trim(),
    date: el("invDate").value,
    due: el("invDue").value,
    customer: el("invCustomer").value.trim(),
    contact: el("invContact").value.trim(),
    desc: el("invDesc").value.trim(),
    total: Number(el("invTotal").value||0),
  };
  if(!inv.no || !inv.customer || !inv.date || !inv.due || inv.total<=0) return showToast("Gagal","Lengkapi data invoice.");
  addInvoice(inv);
  state.settings.invoiceNext = Number(state.settings.invoiceNext||1) + 1;
  save();
  closeModal("modalInv");
});

el("closeImport").addEventListener("click", ()=>closeModal("modalImport"));
el("btnImportCancel").addEventListener("click", ()=>closeModal("modalImport"));
el("btnImportDo").addEventListener("click", doImport);

el("closeDebt").addEventListener("click", ()=>closeModal("modalDebt"));
el("btnDebtCancel").addEventListener("click", ()=>closeModal("modalDebt"));
el("debtForm").addEventListener("submit", (e)=>{
  e.preventDefault();
  const kind = el("debtKind").value;
  const item = {
    name: el("debtName").value.trim(),
    counterparty: el("debtParty").value.trim(),
    due: el("debtDue").value,
    amount: Number(el("debtAmount").value||0),
    note: el("debtNote").value.trim()
  };
  if(!item.name || !item.counterparty || !item.due || item.amount<=0) return showToast("Gagal","Lengkapi data.");
  addDebtItem(kind, item);
  closeModal("modalDebt");
});

/* Global close on overlay click */
["modalTx","modalInv","modalImport","modalDebt"].forEach(id=>{
  el(id).addEventListener("click", (e)=>{
    if(e.target === el(id)) closeModal(id);
  });
});

/* Init */
el("ver").textContent = "v"+VERSION;
render();
</script>
</body>
</html>
